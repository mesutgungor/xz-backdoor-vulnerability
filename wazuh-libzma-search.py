import requests
import os
import time
import csv

from requests.auth import HTTPBasicAuth
from requests.structures import CaseInsensitiveDict

requests.packages.urllib3.disable_warnings()
passw = os.environ['wazuh-api-pass']
wazuhapi_user = os.environ['wazuh-api-user']
base_url = "wazuh-url"
auth = HTTPBasicAuth(wazuhapi_user,passw)
res_wazuh=requests.get(base_url+"security/user/authenticate?raw=true",auth=auth, verify=False)
wazuh_jwt_token=res_wazuh.text


headers = CaseInsensitiveDict()
headers["Accept"] = "application/json"
headers["Authorization"] = 'Bearer '+wazuh_jwt_token
params = {'name': 'liblzma5' }

response = requests.get(base_url+"experimental/syscollector/packages", headers=headers, params=params, verify=False)
print(response.json())
filename = time.strftime("%Y%m%d-%H%M%S")
csv_file = 'software_found_'+filename+'.csv'
csv_headers = ['Name', 'Vendor', 'Version', 'Description', 'Agent ID']

if response.status_code==200:
    with open(csv_file, 'a', newline='') as file:
        writer = csv.writer(file)
        for software in response.json()['data']['affected_items']:
            name = software['name'] if "name" in software else ''
            vendor = software['vendor'] if "vendor" in software else ''
            version = software['version'] if "version" in software  else ''
            description = software['description'] if "description" in software else ''
            agent_id = software['agent_id'] if "agent_id" in software else ''
            writer.writerow([name, vendor, version, description, agent_id])
